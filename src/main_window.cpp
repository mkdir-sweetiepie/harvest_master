/**
 * @file /src/main_window.cpp
 *
 * @brief Implementation for the qt gui.
 *
 * @date January 2025
 **/
/*****************************************************************************
** Includes
*****************************************************************************/

#include "../include/harvest_master/main_window.hpp"

MainWindow::MainWindow(QWidget* parent) : QMainWindow(parent), ui(new Ui::MainWindowDesign)
{
  ui->setupUi(this);

  QIcon icon("://ros-icon.png");
  this->setWindowIcon(icon);

  qnode = new QNode();

  // Initialize variables
  harvestCount = 0;
  successCount = 0;
  isVisionActive = false;
  isArmReady = true;

  // Setup UI connections
  setupConnections();
  
  // Setup timers
  setupTimers();
  
  // Initialize UI values
  initializeUI();

  QObject::connect(qnode, SIGNAL(rosShutDown()), this, SLOT(close()));
}

void MainWindow::setupConnections()
{
  // Vision System Controls
  connect(ui->startVisionBtn, &QPushButton::clicked, this, &MainWindow::onStartVision);
  connect(ui->captureBtn, &QPushButton::clicked, this, &MainWindow::onCapture);
  connect(ui->calibrateBtn, &QPushButton::clicked, this, &MainWindow::onCalibrate);
  
  // Manipulation Controls
  connect(ui->harvestBtn, &QPushButton::clicked, this, &MainWindow::onStartHarvest);
  connect(ui->moveToTargetBtn, &QPushButton::clicked, this, &MainWindow::onMoveToTarget);
  connect(ui->gripBtn, &QPushButton::clicked, this, &MainWindow::onGrip);
  connect(ui->homeBtn, &QPushButton::clicked, this, &MainWindow::onMoveHome);
  connect(ui->dropBtn, &QPushButton::clicked, this, &MainWindow::onMoveToDrop);
  
  // Emergency Controls
  connect(ui->emergencyBtn, &QPushButton::clicked, this, &MainWindow::onEmergencyStop);
  connect(ui->resetArmBtn, &QPushButton::clicked, this, &MainWindow::onResetArm);
  connect(ui->resetVisionBtn, &QPushButton::clicked, this, &MainWindow::onResetVision);

  // Menu Actions
  connect(ui->action_StartVision, &QAction::triggered, this, &MainWindow::onStartVision);
  connect(ui->action_Calibrate, &QAction::triggered, this, &MainWindow::onCalibrate);
  connect(ui->action_HomePosition, &QAction::triggered, this, &MainWindow::onMoveHome);
  connect(ui->action_EmergencyStop, &QAction::triggered, this, &MainWindow::onEmergencyStop);
  
  // ROS2 Signal Connections
  connect(qnode, &QNode::imageReceived, this, &MainWindow::onImageReceived);
  connect(qnode, &QNode::melonDetected, this, &MainWindow::onMelonDetected);
  connect(qnode, &QNode::systemStatusChanged, this, &MainWindow::onSystemStatusChanged);
  connect(qnode, &QNode::targetSelected, this, &MainWindow::onTargetSelected);
}

void MainWindow::setupTimers()
{
  // Timer for updating UI data
  updateTimer = new QTimer(this);
  connect(updateTimer, &QTimer::timeout, this, &MainWindow::updateUI);
  updateTimer->start(100); // Update every 100ms
}

void MainWindow::initializeUI()
{
  // Initial status
  ui->armStatusLabel->setText("READY TO HARVEST");
  ui->armPositionLabel->setText("X:0 Y:0 Z:200");
  ui->gripperLabel->setText("OPEN - Ï§ÄÎπÑÏôÑÎ£å");
  ui->processingLabel->setText("18.5 FPS");
  ui->selectedMelonLabel->setText("ÎåÄÍ∏∞ Ï§ë...");
  ui->todayCountLabel->setText("0Í∞ú");
  ui->avgTimeLabel->setText("--Ï¥à/Í∞ú");
  
  // Progress bars
  ui->accuracyProgress->setValue(96);
  ui->successProgress->setValue(100);
  
  // System messages
  appendSystemMessage("[SYSTEM]", "Ï∞∏Ïô∏ ÏàòÌôï ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî ÏôÑÎ£å", "#4a90e2");
}

void MainWindow::updateUI()
{
  // Update harvest statistics
  ui->todayCountLabel->setText(QString::number(harvestCount) + "Í∞ú");
  
  if (harvestCount > 0) {
    int successRate = (successCount * 100) / harvestCount;
    ui->successProgress->setValue(successRate);
    
    // Calculate average time (example calculation)
    double avgTime = 12.3 + (harvestCount * 0.1); // Simulate getting slower
    ui->avgTimeLabel->setText(QString::number(avgTime, 'f', 1) + "Ï¥à/Í∞ú");
  }

  // Update vision status
  if (isVisionActive) {
    ui->startVisionBtn->setText("‚èπÔ∏è ÎπÑÏ†Ñ Ï†ïÏßÄ");
    ui->statusLabel->setText("‚óè VISION ACTIVE & ARM READY");
  } else {
    ui->startVisionBtn->setText("üîç ÎπÑÏ†Ñ ÏãúÏûë");
    ui->statusLabel->setText("‚óè VISION STANDBY & ARM READY");
  }
}

void MainWindow::appendSystemMessage(const QString& type, const QString& message, const QString& color)
{
  QString timestamp = QTime::currentTime().toString("hh:mm:ss");
  QString formattedMsg = QString("<span style='color:%1'>[%2]</span> %3 - %4")
                        .arg(color)
                        .arg(type)
                        .arg(timestamp)
                        .arg(message);
  
  ui->messagesTextEdit->append(formattedMsg);
  
  // Keep only last 50 messages
  QTextDocument* doc = ui->messagesTextEdit->document();
  if (doc->blockCount() > 50) {
    QTextCursor cursor = ui->messagesTextEdit->textCursor();
    cursor.movePosition(QTextCursor::Start);
    cursor.select(QTextCursor::BlockUnderCursor);
    cursor.removeSelectedText();
  }
}

// Vision System Slots
void MainWindow::onStartVision()
{
  if (!isVisionActive) {
    isVisionActive = true;
    qnode->startVisionSystem(); // Ïã§Ï†ú ROS2 Ìò∏Ï∂ú
    appendSystemMessage("VISION", "ÎπÑÏ†Ñ ÏãúÏä§ÌÖú ÏãúÏûë", "#4a90e2");
  } else {
    isVisionActive = false;
    qnode->stopVisionSystem(); // Ïã§Ï†ú ROS2 Ìò∏Ï∂ú
    appendSystemMessage("VISION", "ÎπÑÏ†Ñ ÏãúÏä§ÌÖú Ï†ïÏßÄ", "#f39c12");
  }
}

void MainWindow::onCapture()
{
  qnode->captureImage(); // Ïã§Ï†ú ROS2 Ìò∏Ï∂ú
  appendSystemMessage("VISION", "Ïù¥ÎØ∏ÏßÄ Ï∫°Ï≤ò ÏôÑÎ£å", "#4a90e2");
}

void MainWindow::onCalibrate()
{
  appendSystemMessage("VISION", "Ïπ¥Î©îÎùº Ï∫òÎ¶¨Î∏åÎ†àÏù¥ÏÖò ÏãúÏûë", "#f39c12");
  ui->calibrateBtn->setEnabled(false);
  
  qnode->calibrateCamera(); // Ïã§Ï†ú ROS2 Ìò∏Ï∂ú
  
  // Simulate calibration process
  QTimer::singleShot(3000, [this]() {
    ui->calibrateBtn->setEnabled(true);
    appendSystemMessage("VISION", "Ï∫òÎ¶¨Î∏åÎ†àÏù¥ÏÖò ÏôÑÎ£å", "#2ecc71");
  });
}

// Manipulation System Slots
void MainWindow::onStartHarvest()
{
  if (!isArmReady) {
    appendSystemMessage("ERROR", "Î°úÎ¥á ÏïîÏù¥ Ï§ÄÎπÑÎêòÏßÄ ÏïäÏùå", "#e74c3c");
    return;
  }
  
  if (!isVisionActive) {
    appendSystemMessage("ERROR", "ÎπÑÏ†Ñ ÏãúÏä§ÌÖúÏù¥ ÌôúÏÑ±ÌôîÎêòÏßÄ ÏïäÏùå", "#e74c3c");
    return;
  }
  
  isArmReady = false;
  ui->harvestBtn->setEnabled(false);
  ui->armStatusLabel->setText("HARVESTING...");
  
  qnode->startHarvest(); // Ïã§Ï†ú ROS2 Ìò∏Ï∂ú
  appendSystemMessage("ARM", "Ï∞∏Ïô∏ ÏàòÌôï ÏãúÏûë", "#27ae60");
  
  // Simulate harvest sequence
  QTimer::singleShot(5000, [this]() {
    harvestCount++;
    successCount++; // For demo, assume always success
    isArmReady = true;
    ui->harvestBtn->setEnabled(true);
    ui->armStatusLabel->setText("READY TO HARVEST");
    
    appendSystemMessage("SUCCESS", QString("Ï∞∏Ïô∏ #%1 ÏàòÌôï ÏôÑÎ£å").arg(harvestCount), "#2ecc71");
  });
}

void MainWindow::onMoveToTarget()
{
  ui->armStatusLabel->setText("MOVING TO TARGET...");
  appendSystemMessage("ARM", "ÌÉÄÍ≤ü ÏúÑÏπòÎ°ú Ïù¥Îèô Ï§ë", "#4a90e2");
  
  // Get target coordinates from vision system (example coordinates)
  qnode->moveToTarget(245, 180, 150); // Ïã§Ï†ú ROS2 Ìò∏Ï∂ú
  
  QTimer::singleShot(2000, [this]() {
    ui->armStatusLabel->setText("AT TARGET POSITION");
    appendSystemMessage("ARM", "ÌÉÄÍ≤ü ÏúÑÏπò ÎèÑÎã¨", "#2ecc71");
  });
}

void MainWindow::onGrip()
{
  QString currentGripperState = ui->gripperLabel->text();
  
  if (currentGripperState.contains("OPEN")) {
    ui->gripperLabel->setText("CLOSED - Ï∞∏Ïô∏ Í∑∏Î¶Ω");
    appendSystemMessage("ARM", "Í∑∏Î¶¨Ìçº Îã´Ïùå - Ï∞∏Ïô∏ ÌååÏßÄ", "#27ae60");
    ui->gripBtn->setText("üëê Î¶¥Î¶¨Ï¶à");
    qnode->controlGripper(true); // Ïã§Ï†ú ROS2 Ìò∏Ï∂ú
  } else {
    ui->gripperLabel->setText("OPEN - Ï§ÄÎπÑÏôÑÎ£å");
    appendSystemMessage("ARM", "Í∑∏Î¶¨Ìçº Ïó¥Î¶º", "#4a90e2");
    ui->gripBtn->setText("‚úã Í∑∏Î¶Ω");
    qnode->controlGripper(false); // Ïã§Ï†ú ROS2 Ìò∏Ï∂ú
  }
}

void MainWindow::onMoveHome()
{
  ui->armStatusLabel->setText("MOVING TO HOME...");
  ui->armPositionLabel->setText("X:0 Y:0 Z:200");
  appendSystemMessage("ARM", "Ìôà ÏúÑÏπòÎ°ú Ïù¥Îèô", "#4a90e2");
  
  qnode->moveToHome(); // Ïã§Ï†ú ROS2 Ìò∏Ï∂ú
  
  QTimer::singleShot(3000, [this]() {
    ui->armStatusLabel->setText("AT HOME POSITION");
    ui->gripperLabel->setText("OPEN - Ï§ÄÎπÑÏôÑÎ£å");
    isArmReady = true;
    appendSystemMessage("ARM", "Ìôà ÏúÑÏπò ÎèÑÎã¨", "#2ecc71");
  });
}

void MainWindow::onMoveToDrop()
{
  ui->armStatusLabel->setText("MOVING TO DROP ZONE...");
  ui->armPositionLabel->setText("X:-100 Y:0 Z:150");
  appendSystemMessage("ARM", "ÏàòÌôïÌÜµÏúºÎ°ú Ïù¥Îèô", "#4a90e2");
  
  qnode->moveToDropZone(); // Ïã§Ï†ú ROS2 Ìò∏Ï∂ú
  
  QTimer::singleShot(2000, [this]() {
    ui->armStatusLabel->setText("AT DROP ZONE");
    appendSystemMessage("ARM", "ÏàòÌôïÌÜµ ÏúÑÏπò ÎèÑÎã¨", "#2ecc71");
  });
}

// Emergency Controls
void MainWindow::onEmergencyStop()
{
  isArmReady = false;
  isVisionActive = false;
  
  qnode->emergencyStop(); // Ïã§Ï†ú ROS2 Ìò∏Ï∂ú
  
  ui->armStatusLabel->setText("üö® EMERGENCY STOP");
  ui->armStatusLabel->setStyleSheet("color: #e74c3c; font-weight: bold;");
  ui->statusLabel->setText("üö® EMERGENCY MODE");
  ui->statusLabel->setStyleSheet("color: #e74c3c; font-weight: bold;");
  
  // Disable all control buttons
  ui->harvestBtn->setEnabled(false);
  ui->moveToTargetBtn->setEnabled(false);
  ui->gripBtn->setEnabled(false);
  ui->homeBtn->setEnabled(false);
  ui->dropBtn->setEnabled(false);
  ui->startVisionBtn->setEnabled(false);
  
  appendSystemMessage("EMERGENCY", "ÎπÑÏÉÅ Ï†ïÏßÄ ÌôúÏÑ±Ìôî", "#e74c3c");
}

void MainWindow::onResetArm()
{
  ui->armStatusLabel->setText("RESETTING ARM...");
  ui->armStatusLabel->setStyleSheet(""); // Reset style
  
  qnode->resetArm(); // Ïã§Ï†ú ROS2 Ìò∏Ï∂ú
  appendSystemMessage("ARM", "Î°úÎ¥á Ïïî Î¶¨ÏÖã Ï§ë", "#f39c12");
  
  QTimer::singleShot(5000, [this]() {
    isArmReady = true;
    ui->armStatusLabel->setText("READY TO HARVEST");
    ui->armPositionLabel->setText("X:0 Y:0 Z:200");
    ui->gripperLabel->setText("OPEN - Ï§ÄÎπÑÏôÑÎ£å");
    
    // Re-enable arm control buttons
    ui->harvestBtn->setEnabled(true);
    ui->moveToTargetBtn->setEnabled(true);
    ui->gripBtn->setEnabled(true);
    ui->homeBtn->setEnabled(true);
    ui->dropBtn->setEnabled(true);
    
    ui->statusLabel->setText("‚óè VISION & MANIPULATION READY");
    ui->statusLabel->setStyleSheet(""); // Reset style
    
    appendSystemMessage("ARM", "Î°úÎ¥á Ïïî Î¶¨ÏÖã ÏôÑÎ£å", "#2ecc71");
  });
}

void MainWindow::onResetVision()
{
  ui->selectedMelonLabel->setText("Î¶¨ÏÖã Ï§ë...");
  appendSystemMessage("VISION", "ÎπÑÏ†Ñ ÏãúÏä§ÌÖú Î¶¨ÏÖã Ï§ë", "#f39c12");
  
  // Stop vision first, then restart
  qnode->stopVisionSystem();
  
  QTimer::singleShot(3000, [this]() {
    isVisionActive = false;
    ui->selectedMelonLabel->setText("ÎåÄÍ∏∞ Ï§ë...");
    ui->startVisionBtn->setEnabled(true);
    ui->calibrateBtn->setEnabled(true);
    
    // Clear camera feed
    ui->cameraFeed->clear();
    ui->cameraFeed->setText("üì∑ VISION SYSTEM STANDBY\n\nÎπÑÏ†Ñ ÏãúÏä§ÌÖúÏùÑ ÏãúÏûëÌïòÏÑ∏Ïöî");
    
    ui->statusLabel->setText("‚óè VISION & MANIPULATION READY");
    ui->statusLabel->setStyleSheet(""); // Reset style
    
    appendSystemMessage("VISION", "ÎπÑÏ†Ñ ÏãúÏä§ÌÖú Î¶¨ÏÖã ÏôÑÎ£å", "#2ecc71");
  });
}

void MainWindow::closeEvent(QCloseEvent* event)
{
  if (updateTimer) {
    updateTimer->stop();
  }
  QMainWindow::closeEvent(event);
}

MainWindow::~MainWindow()
{
  delete ui;
}

/*****************************************************************************
** ROS2 Signal Slots
*****************************************************************************/

void MainWindow::onImageReceived(const QPixmap& pixmap)
{
  if (!pixmap.isNull()) {
    // Scale image to fit the camera feed label while maintaining aspect ratio
    QPixmap scaledPixmap = pixmap.scaled(ui->cameraFeed->size(), 
                                        Qt::KeepAspectRatio, 
                                        Qt::SmoothTransformation);
    ui->cameraFeed->setPixmap(scaledPixmap);
    ui->cameraFeed->setText(""); // Remove text when showing image
  }
}

void MainWindow::onMelonDetected(int count, int ripe_count)
{
  // Update camera feed info text overlay (could be overlaid on image)
  QString detectionInfo = QString("üì∑ VISION ACTIVE\n\nüçà Ï∞∏Ïô∏ Í∞êÏßÄÎê®: %1Í∞ú\nüü¢ ÏàòÌôï Í∞ÄÎä•: %2Í∞ú\nüî¥ ÎØ∏ÏÑ±Ïàô: %3Í∞ú\n‚ö†Ô∏è Ïû•Ïï†Î¨º: ÏóÜÏùå")
                         .arg(count)
                         .arg(ripe_count)
                         .arg(count - ripe_count);
  
  // Update analysis results
  ui->selectedMelonLabel->setText(QString("Í∞êÏßÄÎêú Ï∞∏Ïô∏: %1Í∞ú | ÏàòÌôï Í∞ÄÎä•: %2Í∞ú").arg(count).arg(ripe_count));
  
  // Log detection results
  appendSystemMessage("VISION", QString("Ï∞∏Ïô∏ %1Í∞ú Í∞êÏßÄ (ÏàòÌôïÍ∞ÄÎä•: %2Í∞ú)").arg(count).arg(ripe_count), "#4a90e2");
}

void MainWindow::onSystemStatusChanged(const QString& status)
{
  // Update system status based on ROS2 messages
  ui->statusLabel->setText("‚óè " + status);
  appendSystemMessage("SYSTEM", status, "#4a90e2");
}

void MainWindow::onTargetSelected(double x, double y)
{
  // Update target information
  ui->selectedMelonLabel->setText(QString("ÌÉÄÍ≤ü ÏÑ†ÌÉùÎê®: (%.0f, %.0f)").arg(x).arg(y));
  ui->armPositionLabel->setText(QString("Target: X:%.0f Y:%.0f Z:150").arg(x).arg(y));
  
  appendSystemMessage("VISION", QString("ÏÉàÎ°úÏö¥ ÌÉÄÍ≤ü ÏÑ†ÌÉù: (%.0f, %.0f)").arg(x).arg(y), "#27ae60");
}